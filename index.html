<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pedidos Mayoristas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuraci√≥n Global de Firebase (MANDATORIA)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Variables globales para la aplicaci√≥n
        window.app = null;
        window.db = null;
        window.auth = null;
        window.dbReady = false; // Nuevo indicador de estado de la DB
        
        setLogLevel('debug'); 

        // Estado Global de la Aplicaci√≥n
        const state = {
            cart: JSON.parse(localStorage.getItem('multigestiones_cart')) || [],
            currentFilter: 'Todos',
        };

        const ELEMENTS = {
            productList: document.getElementById('product-list'),
            filterContainer: document.getElementById('filter-container'),
            cartCount: document.getElementById('cart-count'),
            cartView: document.getElementById('cart-view'),
            catalogView: document.getElementById('catalog-view'),
            viewCartBtn: document.getElementById('view-cart-btn'),
            backToCatalogBtn: document.getElementById('back-to-catalog-btn'),
            cartItemDetails: document.getElementById('cart-item-details'),
            cartTotal: document.getElementById('cart-total'),
            emptyCartMessage: document.getElementById('empty-cart-message'),
            clientForm: document.getElementById('client-form'),
            confirmOrderBtn: document.getElementById('confirm-order-btn'),
            orderStatus: document.getElementById('order-status'),
            confirmationModal: document.getElementById('confirmation-modal'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            minQtyAlert: document.getElementById('min-qty-alert'),
            loadingIndicator: document.getElementById('loading-indicator'),
            btnText: document.getElementById('btn-text'),
        };

        // --- INICIALIZACI√ìN DE FIREBASE Y AUTHENTICACI√ìN ---

        const authenticate = async () => {
            if (!firebaseConfig) {
                console.error("Configuraci√≥n de Firebase no disponible. Cargando modo offline.");
                window.dbReady = false;
                window.mainApp.init(); 
                return;
            }

            try {
                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
                
                window.dbReady = true; // DB lista
                window.mainApp.init(); 

            } catch (error) {
                console.error("Error de conexi√≥n o autenticaci√≥n de Firebase. Cargando modo offline:", error);
                window.dbReady = false;
                window.mainApp.init(); // Cargar la app incluso si falla la DB
            }
        };

        // Exportar funciones esenciales para el c√≥digo de la aplicaci√≥n
        window.firebaseExports = {
            addDoc,
            collection,
            serverTimestamp,
        };

        // --- DEFINICI√ìN DE PRODUCTOS Y L√ìGICA DE LA APP (MISMO C√ìDIGO) ---

        // Precios en Guaran√≠es (Gs.)
        const PRODUCTS = [
            // CATEROR√çA DE ALQUILER PARA EVENTOS (M√≠nimo 1)
            { id: 1, name: "Silla Pl√°stica Reforzada", brand: "Servicios", presentation: "Unidad/Evento", price: 1500, category: "Alquiler Eventos", logoColor: "#34d399", logoText: "Silla ü™ë", isRental: true, min: 1 },
            { id: 2, name: "Mesa Redonda (10 personas)", brand: "Servicios", presentation: "Unidad/Evento", price: 15000, category: "Alquiler Eventos", logoColor: "#34d399", logoText: "Mesa üçΩÔ∏è", isRental: true, min: 1 },
            { id: 3, name: "Mesa Larga (8 personas)", brand: "Servicios", presentation: "Unidad/Evento", price: 12000, category: "Alquiler Eventos", logoColor: "#34d399", logoText: "Mesa üìè", isRental: true, min: 1 },
            { id: 4, name: "Mantel Blanco de Tela", brand: "Servicios", presentation: "Unidad/Evento", price: 7000, category: "Alquiler Eventos", logoColor: "#fcd34d", logoText: "Mantel", isRental: true, min: 1 },
            { id: 5, name: "Cubiertos Met√°licos (Set)", brand: "Servicios", presentation: "Set/Evento", price: 800, category: "Alquiler Eventos", logoColor: "#94a3b8", logoText: "Cubiertos", isRental: true, min: 1 },
            { id: 6, name: "Cubre Sillas", brand: "Servicios", presentation: "Unidad/Evento", price: 1000, category: "Alquiler Eventos", logoColor: "#fcd34d", logoText: "Cubre", isRental: true, min: 1 },
            { id: 7, name: "Plato Cer√°mica (Principal)", brand: "Servicios", presentation: "Unidad/Evento", price: 900, category: "Alquiler Eventos", logoColor: "#94a3b8", logoText: "Plato", isRental: true, min: 1 },
            { id: 8, name: "Vasos de Cristal", brand: "Servicios", presentation: "Unidad/Evento", price: 700, category: "Alquiler Eventos", logoColor: "#94a3b8", logoText: "Vaso", isRental: true, min: 1 },
            { id: 9, name: "Plato Pl√°stico Reforzado", brand: "Pl√°sticos", presentation: "Unidad/Evento", price: 600, category: "Alquiler Eventos", logoColor: "#38bdf8", logoText: "Pl√°stico", isRental: true, min: 1 },
            { id: 10, name: "Vasos Pl√°sticos Reutilizables", brand: "Pl√°sticos", presentation: "Unidad/Evento", price: 500, category: "Alquiler Eventos", logoColor: "#38bdf8", logoText: "Pl√°stico", isRental: true, min: 1 },

            // ABARROTES: L√ÅCTEOS (Mayorista - M√≠nimo 3)
            { id: 11, name: "Leche Entera UAT", brand: "Tr√©bol", presentation: "1 Litro", price: 8500, category: "L√°cteos", logoColor: "#059669", logoText: "Tr√©bol", isRental: false, min: 3 },
            { id: 12, name: "Yogurt Entero Durazno", brand: "Tr√©bol", presentation: "1 Litro", price: 9200, category: "L√°cteos", logoColor: "#059669", logoText: "Tr√©bol üçë", isRental: false, min: 3 },
            { id: 13, name: "Manteca Premium", brand: "Tr√©bol", presentation: "250g", price: 12500, category: "L√°cteos", logoColor: "#059669", logoText: "Tr√©bol", isRental: false, min: 3 },
            { id: 14, name: "Postre Vainilla", brand: "Tr√©bol", presentation: "120g", price: 4000, category: "L√°cteos", logoColor: "#059669", logoText: "Tr√©bol", isRental: false, min: 3 },
            { id: 15, name: "Leche Descremada UAT", brand: "Lactolanda", presentation: "1 Litro", price: 8800, category: "L√°cteos", logoColor: "#f59e0b", logoText: "Landa", isRental: false, min: 3 },
            { id: 16, name: "Queso Paraguay Fresco", brand: "Lactolanda", presentation: "500g", price: 18500, category: "L√°cteos", logoColor: "#f59e0b", logoText: "Landa üßÄ", isRental: false, min: 3 },
            { id: 17, name: "Dulce de Leche Cl√°sico", brand: "Lactolanda", presentation: "400g", price: 15000, category: "L√°cteos", logoColor: "#f59e0b", logoText: "Landa", isRental: false, min: 3 },
            { id: 18, name: "Leche Cultivada", brand: "Lactolanda", presentation: "1 Litro", price: 9500, category: "L√°cteos", logoColor: "#f59e0b", logoText: "Landa", isRental: false, min: 3 },

            // ABARROTES: BEBIDAS (Mayorista - M√≠nimo 3)
            { id: 19, name: "Coca-Cola Original", brand: "Coca-Cola", presentation: "2 Litros", price: 12000, category: "Bebidas", logoColor: "#e61818", logoText: "COKE üî¥", isRental: false, min: 3 },
            { id: 20, name: "Coca-Cola Sin Az√∫car", brand: "Coca-Cola", presentation: "1.5 Litros", price: 9500, category: "Bebidas", logoColor: "#e61818", logoText: "COKE Zero", isRental: false, min: 3 },
            { id: 21, name: "Gaseosa Fanta Naranja", brand: "Coca-Cola", presentation: "2 Litros", price: 10500, category: "Bebidas", logoColor: "#f97316", logoText: "FANTA", isRental: false, min: 3 },
            { id: 22, name: "Jugo (Sabor Naranja)", brand: "Pulp", presentation: "1 Litro", price: 7500, category: "Bebidas", logoColor: "#f97316", logoText: "Pulp üçä", isRental: false, min: 3 },
            { id: 23, name: "Cerveza Pilsen", brand: "Brahma", presentation: "Lata 350ml", price: 6000, category: "Bebidas", logoColor: "#fbbf24", logoText: "Brahma üç∫", isRental: false, min: 3 },
            { id: 24, name: "Cerveza Lager", brand: "Pilsen", presentation: "Botella 1L", price: 11500, category: "Bebidas", logoColor: "#0369a1", logoText: "Pilsen", isRental: false, min: 3 },
            { id: 25, name: "Agua Mineral sin Gas", brand: "Salus", presentation: "1.5 Litros", price: 4500, category: "Bebidas", logoColor: "#4c9cfd", logoText: "Salus", isRental: false, min: 3 },
            { id: 26, name: "Cerveza Lata", brand: "Heineken", presentation: "330ml Lata", price: 7800, category: "Bebidas", logoColor: "#10b981", logoText: "Heineken üç∫", isRental: false, min: 3 },
            { id: 27, name: "Gaseosa Guaran√°", brand: "Guaran√°", presentation: "2 Litros", price: 9000, category: "Bebidas", logoColor: "#3b82f6", logoText: "Guaran√°", isRental: false, min: 3 },
            { id: 28, name: "Agua Saborizada Manzana", brand: "Levit√©", presentation: "600ml", price: 5500, category: "Bebidas", logoColor: "#22c55e", logoText: "Levit√©", isRental: false, min: 3 },
            { id: 29, name: "Vino Tinto Seco", brand: "Santa Helena", presentation: "750ml", price: 35000, category: "Bebidas", logoColor: "#dc2626", logoText: "Vino üç∑", isRental: false, min: 3 },

            // ABARROTES: NO PERECEDEROS (Mayorista - M√≠nimo 3)
            { id: 30, name: "Fideo Spaghetti", brand: "Fortaleza", presentation: "500g", price: 5000, category: "Abarrotes", logoColor: "#ef4444", logoText: "Fuerza", isRental: false, min: 3 },
            { id: 31, name: "Fideo Tallar√≠n", brand: "Adria", presentation: "500g", price: 4800, category: "Abarrotes", logoColor: "#1d4ed8", logoText: "Adria", isRental: false, min: 3 },
            { id: 32, name: "Arroz Grano Largo Tipo 1", brand: "Universo", presentation: "1Kg", price: 8500, category: "Abarrotes", logoColor: "#9333ea", logoText: "Universo", isRental: false, min: 3 },
            { id: 33, name: "Harina de Trigo 000", brand: "Hijo de Tigre", presentation: "1Kg", price: 6500, category: "Abarrotes", logoColor: "#334155", logoText: "Tigre", isRental: false, min: 3 },
            { id: 34, name: "Az√∫car Rubia", brand: "Azucarera Nacional", presentation: "1Kg", price: 5200, category: "Abarrotes", logoColor: "#fb7185", logoText: "Az√∫car", isRental: false, min: 3 },
            { id: 35, name: "Sal Fina Yodada", brand: "Marina", presentation: "500g", price: 2500, category: "Abarrotes", logoColor: "#94a3b8", logoText: "Marina", isRental: false, min: 3 },
            { id: 36, name: "Aceite Girasol", brand: "Cocinero", presentation: "900ml", price: 15000, category: "Abarrotes", logoColor: "#facc15", logoText: "Cocinero", isRental: false, min: 3 },
            { id: 37, name: "Yerba Mate Cl√°sica", brand: "Kurup√≠", presentation: "500g", price: 15500, category: "Abarrotes", logoColor: "#22c55e", logoText: "Kurup√≠", isRental: false, min: 3 },
            { id: 38, name: "Yerba Mate Compuesta", brand: "Selecta", presentation: "1Kg", price: 28000, category: "Abarrotes", logoColor: "#059669", logoText: "Selecta", isRental: false, min: 3 },
            { id: 39, name: "Poroto Negro", brand: "El Molino", presentation: "1Kg", price: 9000, category: "Abarrotes", logoColor: "#9333ea", logoText: "Molino", isRental: false, min: 3 },
            { id: 40, name: "Lentejas", brand: "El Molino", presentation: "500g", price: 6500, category: "Abarrotes", logoColor: "#9333ea", logoText: "Molino", isRental: false, min: 3 },
            { id: 41, name: "Mayonesa Cl√°sica", brand: "Hellmann's", presentation: "500g Pote", price: 13000, category: "Abarrotes", logoColor: "#facc15", logoText: "Hellman's", isRental: false, min: 3 },
            { id: 42, name: "Ketchup", brand: "Heinz", presentation: "397g", price: 11500, category: "Abarrotes", logoColor: "#ef4444", logoText: "Heinz", isRental: false, min: 3 },
            { id: 43, name: "Caf√© Instant√°neo", brand: "Nescaf√©", presentation: "100g", price: 18000, category: "Abarrotes", logoColor: "#994d1b", logoText: "Caf√©", isRental: false, min: 3 },
            { id: 44, name: "Mermelada Frutilla", brand: "Arcor", presentation: "400g", price: 9800, category: "Abarrotes", logoColor: "#dc2626", logoText: "Arcor üçì", isRental: false, min: 3 },
            { id: 45, name: "Caldo Cubitos Carne", brand: "Maggi", presentation: "Caja x 12", price: 7000, category: "Abarrotes", logoColor: "#f97316", logoText: "Maggi", isRental: false, min: 3 },
            { id: 46, name: "At√∫n en Aceite", brand: "La Sirena", presentation: "170g Lata", price: 11000, category: "Abarrotes", logoColor: "#0891b2", logoText: "Sirena üêü", isRental: false, min: 3 },
            { id: 47, name: "Arvejas en Lata", brand: "Arcor", presentation: "300g Lata", price: 4500, category: "Abarrotes", logoColor: "#dc2626", logoText: "Arcor", isRental: false, min: 3 },
            { id: 48, name: "Tomate Pelado Cubeteado", brand: "Mutti", presentation: "400g Lata", price: 8000, category: "Abarrotes", logoColor: "#b91c1c", logoText: "Mutti", isRental: false, min: 3 },
            { id: 49, name: "Choclo en Grano", brand: "Arcor", presentation: "300g Lata", price: 5500, category: "Abarrotes", logoColor: "#dc2626", logoText: "Arcor üåΩ", isRental: false, min: 3 },
            { id: 50, name: "Salsa de Tomate Lista", brand: "Mutti", presentation: "520g Botella", price: 9000, category: "Abarrotes", logoColor: "#b91c1c", logoText: "Mutti", isRental: false, min: 3 },

            // ABARROTES: SNACKS (Mayorista - M√≠nimo 3)
            { id: 51, name: "Papas Fritas Onduladas", brand: "Karup√°", presentation: "60g", price: 3500, category: "Snacks", logoColor: "#7e22ce", logoText: "Karup√° ü•î", isRental: false, min: 3 },
            { id: 52, name: "Chizitos Queso", brand: "Do√±a", presentation: "80g", price: 4200, category: "Snacks", logoColor: "#ca8a04", logoText: "Do√±a üßÄ", isRental: false, min: 3 },
            { id: 53, name: "Galleta Chocolate Rellena", brand: "Oreo", presentation: "Pack", price: 6500, category: "Snacks", logoColor: "#1e3a8a", logoText: "Oreo", isRental: false, min: 3 },
            { id: 54, name: "Alfajor Triple Chocolate", brand: "Jorgito", presentation: "Unidad", price: 4500, category: "Snacks", logoColor: "#0f766e", logoText: "Jorgito", isRental: false, min: 3 },
            { id: 55, name: "Man√≠ Tostado Salado", brand: "Manisa", presentation: "100g", price: 4000, category: "Snacks", logoColor: "#84cc16", logoText: "Manisa", isRental: false, min: 3 },
            { id: 56, name: "Galleta Vainilla", brand: "Arcor", presentation: "Pack x 6", price: 8000, category: "Snacks", logoColor: "#dc2626", logoText: "Arcor", isRental: false, min: 3 },
            { id: 57, name: "Papas Fritas Lisas", brand: "Pringles", presentation: "Lata 120g", price: 15000, category: "Snacks", logoColor: "#ef4444", logoText: "Pringles", isRental: false, min: 3 },
            { id: 58, name: "Caramelos Surtidos", brand: "Arcor", presentation: "Bolsa 500g", price: 12000, category: "Snacks", logoColor: "#dc2626", logoText: "Arcor", isRental: false, min: 3 },
            
            // ABARROTES: CONGELADOS (Mayorista - M√≠nimo 3)
            { id: 59, name: "Papas Fritas Prefritas", brand: "McCain", presentation: "1Kg Bolsa", price: 18000, category: "Congelados", logoColor: "#ef4444", logoText: "McCain üçü", isRental: false, min: 3 },
            { id: 60, name: "Nuggets de Pollo", brand: "Knorr", presentation: "500g Caja", price: 25000, category: "Congelados", logoColor: "#f97316", logoText: "Knorr", isRental: false, min: 3 },
            { id: 61, name: "Pizza Muzzarella", brand: "Sadia", presentation: "Unidad", price: 28000, category: "Congelados", logoColor: "#4f46e5", logoText: "Sadia", isRental: false, min: 3 },
            { id: 62, name: "Vegetales Mixtos", brand: "Quickfood", presentation: "500g Bolsa", price: 11000, category: "Congelados", logoColor: "#0ea5e9", logoText: "Quick", isRental: false, min: 3 },
            { id: 63, name: "Hielo en Cubos", brand: "G√©nesis", presentation: "2Kg Bolsa", price: 4500, category: "Congelados", logoColor: "#3b82f6", logoText: "G√©nesis üßä", isRental: false, min: 3 },
            { id: 64, name: "Hamburguesa Carne", brand: "Sadia", presentation: "Caja x 4", price: 16000, category: "Congelados", logoColor: "#4f46e5", logoText: "Sadia", isRental: false, min: 3 },

            // ABARROTES: LIMPIEZA (Mayorista - M√≠nimo 3)
            { id: 65, name: "Detergente Lavaplatos Lim√≥n", brand: "Magistral", presentation: "500ml", price: 9500, category: "Limpieza", logoColor: "#06b6d4", logoText: "Magis üíß", isRental: false, min: 3 },
            { id: 66, name: "Lavandina Desinfectante", brand: "Sapolio", presentation: "1 Litro", price: 6000, category: "Limpieza", logoColor: "#4f46e5", logoText: "Sapolio ‚ö°", isRental: false, min: 3 },
            { id: 67, name: "Jab√≥n en Polvo", brand: "OMO", presentation: "1Kg", price: 22000, category: "Limpieza", logoColor: "#0ea5e9", logoText: "OMO", isRental: false, min: 3 },
            { id: 68, name: "Suavizante Concentrado", brand: "Vanish", presentation: "900ml", price: 15800, category: "Limpieza", logoColor: "#c026d3", logoText: "Vanish", isRental: false, min: 3 },
            { id: 69, name: "Limpiador Vidrios", brand: "Mr. M√∫sculo", presentation: "500ml", price: 8500, category: "Limpieza", logoColor: "#22c55e", logoText: "M√∫sculo", isRental: false, min: 3 },
            { id: 70, name: "Papel Higi√©nico Doble Hoja", brand: "Nevada", presentation: "Pack x 4", price: 14500, category: "Limpieza", logoColor: "#facc15", logoText: "Nevada", isRental: false, min: 3 },
            { id: 71, name: "Jab√≥n de Tocador", brand: "Dove", presentation: "Unidad", price: 4000, category: "Limpieza", logoColor: "#0ea5e9", logoText: "Dove", isRental: false, min: 3 },
            { id: 72, name: "Bolsa de Basura Reforzada", brand: "Rey", presentation: "Pack x 10", price: 10000, category: "Limpieza", logoColor: "#1f2937", logoText: "Rey üëë", isRental: false, min: 3 },
            { id: 73, name: "Limpiador Desinfectante", brand: "Lysoform", presentation: "500ml", price: 9800, category: "Limpieza", logoColor: "#4f46e5", logoText: "Lysoform", isRental: false, min: 3 },
        ];

        const allCategories = PRODUCTS.map(p => p.category);
        const categories = [...new Set(allCategories)];
        categories.unshift('Todos'); 

        // --- FUNCIONES DE CARRITO ---

        function saveCart() {
            localStorage.setItem('multigestiones_cart', JSON.stringify(state.cart));
            updateCartUI();
            checkOrderValidity();
        }

        function updateCartQuantity(productId, newQuantity) {
            const itemIndex = state.cart.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                if (newQuantity <= 0) {
                    state.cart.splice(itemIndex, 1); // Quitar si la cantidad es 0 o menos
                } else {
                    state.cart[itemIndex].quantity = newQuantity;
                }
            }
            saveCart();
            renderProducts(state.currentFilter); // Actualizar el cat√°logo
        }

        function addToCart(productId) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;

            const existingItemIndex = state.cart.findIndex(item => item.id === productId);
            const minQty = product.isRental ? 1 : 3;

            if (existingItemIndex > -1) {
                // Si ya est√° en el carrito, aumentar por la cantidad m√≠nima
                state.cart[existingItemIndex].quantity += minQty;
            } else {
                // Si no est√°, a√±adir la cantidad m√≠nima
                state.cart.push({
                    id: productId,
                    name: product.name,
                    brand: product.brand,
                    price: product.price,
                    presentation: product.presentation,
                    isRental: product.isRental,
                    category: product.category,
                    quantity: minQty,
                });
            }

            saveCart();
        }

        function updateCartUI() {
            elements.cartCount.textContent = state.cart.reduce((total, item) => total + item.quantity, 0);
            renderCartSummary();
        }

        function renderCartSummary() {
            elements.cartItemDetails.innerHTML = '';
            let total = 0;
            const itemsInCart = state.cart.length;

            if (itemsInCart === 0) {
                elements.emptyCartMessage.classList.remove('hidden');
                elements.confirmOrderBtn.disabled = true;
                elements.cartTotal.textContent = 'Gs. 0';
                return;
            } else {
                elements.emptyCartMessage.classList.add('hidden');
            }

            state.cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 bg-white rounded-lg border';
                
                // Info Section
                const infoSection = document.createElement('div');
                infoSection.className = 'flex-grow mb-2 sm:mb-0';
                infoSection.innerHTML = `
                    <p class="font-semibold text-gray-800">${item.name}</p>
                    <p class="text-xs text-gray-500 font-medium">(${item.brand}) ${item.presentation}</p>
                    <p class="text-sm font-medium text-blue-600">Precio c/u: Gs. ${item.price.toLocaleString('es-ES')}</p>
                `;

                // Controls Section
                const controlsSection = document.createElement('div');
                controlsSection.className = 'flex items-center space-x-4 flex-shrink-0';
                
                // Quantity Control
                const qtyControl = document.createElement('div');
                qtyControl.className = 'qty-control flex items-center border rounded-lg';
                qtyControl.innerHTML = `
                    <button type="button" data-action="decrement" data-id="${item.id}" class="rounded-l-lg hover:bg-gray-300">-</button>
                    <input type="text" value="${item.quantity}" readonly class="text-center bg-transparent focus:outline-none">
                    <button type="button" data-action="increment" data-id="${item.id}" class="rounded-r-lg hover:bg-gray-300">+</button>
                `;
                
                // Item Total
                const totalSpan = document.createElement('span');
                totalSpan.className = 'font-bold text-lg text-green-600 w-24 text-right flex-shrink-0';
                totalSpan.textContent = `Gs. ${itemTotal.toLocaleString('es-ES')}`;

                controlsSection.appendChild(qtyControl);
                controlsSection.appendChild(totalSpan);

                itemDiv.appendChild(infoSection);
                itemDiv.appendChild(controlsSection);
                
                elements.cartItemDetails.appendChild(itemDiv);
            });

            elements.cartTotal.textContent = `Gs. ${total.toLocaleString('es-ES')}`;

            // Adjuntar listener para control de cantidad
            document.querySelectorAll('.qty-control button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = parseInt(e.target.dataset.id);
                    const action = e.target.dataset.action;
                    const item = state.cart.find(i => i.id === productId);
                    if (!item) return;

                    let newQty = item.quantity;

                    if (action === 'increment') {
                        newQty += 1;
                    } else if (action === 'decrement') {
                        newQty -= 1;
                        if (newQty < 0) newQty = 0; // Evitar negativos
                    }

                    updateCartQuantity(productId, newQty);
                });
            });

            checkOrderValidity();
        }

        function checkOrderValidity() {
            let isValid = state.cart.length > 0;
            let needsMinQtyAlert = false;
            
            state.cart.forEach(item => {
                // Regla: Productos NO de Alquiler deben ser >= 3
                if (!item.isRental && item.quantity < 3) {
                    isValid = false;
                    needsMinQtyAlert = true;
                }
            });

            if (needsMinQtyAlert) {
                elements.minQtyAlert.classList.remove('hidden');
                // Deshabilitar bot√≥n de confirmar si hay problemas de cantidad O si la DB no est√° lista
                elements.confirmOrderBtn.disabled = true; 
            } else {
                elements.minQtyAlert.classList.add('hidden');
                 // Habilitar si el carrito no est√° vac√≠o, cumple con la cantidad m√≠nima Y la DB est√° lista
                elements.confirmOrderBtn.disabled = !isValid || !elements.clientForm.checkValidity() || !window.dbReady;
            }
           
            // Mensaje si no hay conexi√≥n a DB
            if (!window.dbReady) {
                 elements.orderStatus.textContent = "‚ö†Ô∏è No hay conexi√≥n para enviar pedidos. Por favor, recarga o revisa tu conexi√≥n a Internet.";
                 elements.orderStatus.classList.remove('hidden');
                 elements.orderStatus.classList.add('text-red-600');
            } else if (isValid && window.dbReady) {
                 elements.orderStatus.classList.add('hidden');
            }
        }

        // --- FUNCIONES DE RENDERIZADO DEL CAT√ÅLOGO ---

        function createProductItem(product) {
            const item = document.createElement('div');
            const isRental = product.isRental;
            const minQty = product.min;
            const itemInCart = state.cart.find(i => i.id === product.id);

            item.className = 'product-item p-4 sm:p-5 flex flex-col sm:flex-row items-center justify-between bg-white rounded-lg border-2 ' + (isRental ? 'border-green-300' : 'border-gray-100');
            
            // Secci√≥n Izquierda (Logo e Info)
            const leftSection = document.createElement('div');
            leftSection.className = 'flex items-start space-x-4 sm:space-x-6 w-full sm:w-2/3 mb-3 sm:mb-0';

            // Logo Placeholder
            const logo = document.createElement('div');
            logo.className = 'logo-placeholder shadow-lg flex-shrink-0';
            logo.style.backgroundColor = product.logoColor;
            logo.textContent = product.logoText;
            
            // Info del Producto
            const info = document.createElement('div');
            info.innerHTML = `
                <p class="text-lg font-bold text-gray-900">${product.name}</p>
                <p class="text-sm text-gray-500 font-medium mt-0.5">
                    ${product.presentation} | <span class="font-semibold text-xs ${isRental ? 'text-red-600' : 'text-blue-600'}">
                        ${isRental ? 'Alquiler/Evento' : `Mayorista (M√≠nimo ${minQty})`}
                    </span>
                    ${itemInCart ? `<span class="text-sm font-extrabold text-green-600 ml-2">(En carrito: ${itemInCart.quantity})</span>` : ''}
                </p>
            `;

            leftSection.appendChild(logo);
            leftSection.appendChild(info);

            // Secci√≥n Derecha (Interacci√≥n)
            const rightSection = document.createElement('div');
            rightSection.className = 'flex flex-col items-end space-y-2 w-full sm:w-1/3 justify-end';

            // Precio
            const priceSpan = `<span class="price-badge ${isRental ? 'bg-red-500 text-white' : 'bg-yellow-400 text-gray-900'}">Gs. ${product.price.toLocaleString('es-ES')}</span>`;
            rightSection.innerHTML += priceSpan;

            // Bot√≥n Agregar
            const addButton = document.createElement('button');
            addButton.className = 'add-to-cart-btn w-32 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg text-sm transition duration-150 shadow';
            addButton.textContent = `Agregar (${minQty} U.)`;
            addButton.dataset.id = product.id;
            addButton.addEventListener('click', (e) => {
                addToCart(parseInt(e.target.dataset.id));
            });
            
            rightSection.appendChild(addButton);

            item.appendChild(leftSection);
            item.appendChild(rightSection);
            
            return item;
        }

        function renderProducts(category) {
            elements.productList.innerHTML = '';
            
            const filteredProducts = PRODUCTS.filter(product => 
                category === 'Todos' || product.category === category
            ).sort((a, b) => {
                if (a.category !== b.category) return a.category.localeCompare(b.category);
                if (a.brand !== b.brand) return a.brand.localeCompare(b.brand);
                return a.name.localeCompare(b.name);
            });

            if (filteredProducts.length === 0) {
                elements.productList.innerHTML = `<p class="text-center text-gray-500 py-12 text-lg">No se encontraron productos en la categor√≠a "${category}".</p>`;
                return;
            }

            let currentCategoryTitle = '';
            let currentBrandTitle = '';
            
            filteredProducts.forEach(product => {
                if (category === 'Todos' && product.category !== currentCategoryTitle) {
                    currentCategoryTitle = product.category;
                    const catTitle = document.createElement('h2');
                    catTitle.className = 'text-2xl font-extrabold text-blue-900 mt-8 mb-4 pb-2 border-b-4 border-blue-500';
                    catTitle.textContent = product.category.toUpperCase();
                    elements.productList.appendChild(catTitle);
                    currentBrandTitle = ''; 
                }

                if (product.brand !== currentBrandTitle) {
                    currentBrandTitle = product.brand;
                    const brandTitle = document.createElement('div');
                    brandTitle.className = 'brand-title';
                    brandTitle.textContent = `MARCA: ${product.brand}`;
                    elements.productList.appendChild(brandTitle);
                }

                elements.productList.appendChild(createProductItem(product));
            });

            document.querySelectorAll('.filter-button').forEach(btn => {
                if (btn.textContent.trim() === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function setupFilters() {
            elements.filterContainer.innerHTML = '';
            categories.forEach(cat => {
                const button = document.createElement('button');
                button.className = 'filter-button bg-gray-200 text-gray-700 hover:bg-gray-300 py-2 px-4 rounded-full text-sm shadow-md transition duration-200';
                button.textContent = cat;
                button.addEventListener('click', () => {
                    state.currentFilter = cat;
                    renderProducts(cat);
                });
                elements.filterContainer.appendChild(button);
            });
            state.currentFilter = 'Todos';
            renderProducts(state.currentFilter);
        }
        
        // --- ENV√çO DE ORDEN (FIREBASE) ---

        async function submitOrder(e) {
            e.preventDefault();

            if (state.cart.length === 0) {
                console.error("El carrito est√° vac√≠o. No se puede enviar la orden.");
                return;
            }
            // Verificar si la DB est√° lista antes de intentar enviar
            if (!window.dbReady || !window.db || !window.auth.currentUser) {
                elements.orderStatus.textContent = "Error: Conexi√≥n con la base de datos no disponible. Intenta recargar.";
                elements.orderStatus.classList.remove('hidden');
                elements.orderStatus.classList.add('text-red-600');
                return;
            }

            elements.confirmOrderBtn.disabled = true;
            elements.btnText.textContent = "Enviando...";
            elements.orderStatus.classList.add('hidden');

            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const clientInfo = {
                name: elements.clientForm['client-name'].value,
                phone: elements.clientForm['client-phone'].value,
                address: elements.clientForm['client-address'].value,
                userId: window.auth.currentUser.uid,
            };

            // Mapear los items para guardar solo la informaci√≥n esencial
            const simplifiedItems = state.cart.map(item => ({
                id: item.id,
                name: item.name,
                brand: item.brand,
                quantity: item.quantity,
                price: item.price,
                subtotal: item.quantity * item.price,
                isRental: item.isRental,
            }));


            const orderData = {
                clientInfo: clientInfo,
                items: simplifiedItems,
                totalAmount: total,
                status: 'PENDIENTE',
                timestamp: window.firebaseExports.serverTimestamp(),
                appId: appId,
            };

            const db = window.db;
            const { addDoc, collection } = window.firebaseExports;
            // Guardar en la colecci√≥n p√∫blica de √≥rdenes
            const collectionPath = `/artifacts/${appId}/public/data/orders`;

            try {
                await addDoc(collection(db, collectionPath), orderData);
                
                // Mostrar modal de √©xito
                elements.confirmationModal.classList.remove('hidden');

                // Limpiar carrito
                state.cart = [];
                localStorage.removeItem('multigestiones_cart');

            } catch (error) {
                console.error("Error al guardar la orden en Firestore:", error);
                elements.orderStatus.textContent = "Error al enviar el pedido. Intenta nuevamente.";
                elements.orderStatus.classList.remove('hidden');
                elements.orderStatus.classList.add('text-red-600');
                elements.confirmOrderBtn.disabled = false;
                elements.btnText.textContent = "CONFIRMAR PEDIDO Y ENVIAR";
            }
        }

        // --- MANEJO DE VISTAS Y EVENTOS ---

        function setupEventListeners() {
            elements.viewCartBtn.addEventListener('click', () => {
                elements.catalogView.classList.add('hidden');
                elements.cartView.classList.remove('hidden');
                renderCartSummary();
            });

            elements.backToCatalogBtn.addEventListener('click', () => {
                elements.cartView.classList.add('hidden');
                elements.catalogView.classList.remove('hidden');
                renderProducts(state.currentFilter);
            });

            elements.clientForm.addEventListener('submit', submitOrder);
            
            elements.clientForm.addEventListener('input', checkOrderValidity);

            elements.closeModalBtn.addEventListener('click', () => {
                elements.confirmationModal.classList.add('hidden');
                elements.cartView.classList.add('hidden');
                elements.catalogView.classList.remove('hidden');
                elements.btnText.textContent = "CONFIRMAR PEDIDO Y ENVIAR";
                updateCartUI();
                renderProducts('Todos');
            });
        }

        // --- INICIALIZACI√ìN PRINCIPAL ---
        window.mainApp = {
            init: () => {
                elements.loadingIndicator.classList.add('hidden');
                setupFilters();
                setupEventListeners();
                updateCartUI();
                // Mostrar alerta si la DB no est√° lista (modo offline)
                if (!window.dbReady) {
                    elements.orderStatus.textContent = "‚ö†Ô∏è No hay conexi√≥n para enviar pedidos. Solo se puede navegar. Por favor, recarga.";
                    elements.orderStatus.classList.remove('hidden');
                    elements.orderStatus.classList.add('text-red-600');
                    elements.confirmOrderBtn.disabled = true; // Deshabilitar el bot√≥n de env√≠o
                }
            }
        };

        // Iniciar el proceso de autenticaci√≥n y carga de la aplicaci√≥n
        authenticate();
        
        // Fallback: Si la conexi√≥n tarda mucho (5 segundos), carga la aplicaci√≥n de todos modos.
        setTimeout(() => {
            if (elements.loadingIndicator.classList.contains('hidden')) return;
            console.warn("Conexi√≥n tard√≠a. Forzando la carga de la aplicaci√≥n en modo offline.");
            window.dbReady = false;
            window.mainApp.init(); 
        }, 5000); // 5 segundos de espera m√°xima

    </script>
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        body {
            background-color: #e0e7ff;
            padding: 1rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background-color: #1a202c;
            color: white;
            padding: 2.5rem 1.5rem 1.5rem;
            text-align: center;
        }
        .brand-title {
            background-color: #bfdbfe;
            color: #1e3a8a;
            padding: 8px 16px;
            border-radius: 8px;
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        .price-badge {
            background-color: #f59e0b;
            color: #000000;
            font-weight: 800;
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.9rem;
            margin-bottom: 4px;
            display: inline-block;
        }
        .logo-placeholder {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
            border-radius: 12px;
            text-align: center;
            line-height: 1.2;
            padding: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }
        .filter-button.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
            border-color: #1d4ed8;
        }
        .cart-item-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .qty-control button {
            background-color: #e5e7eb;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0;
            transition: background-color 0.1s;
        }
        .qty-control button:hover {
            background-color: #d1d5db;
        }
        .qty-control input {
            width: 40px;
            text-align: center;
            font-weight: bold;
            border: none;
            padding: 0;
            margin: 0 2px;
            height: 30px;
        }
    </style>
</head>
<body>

    <div class="max-w-4xl mx-auto card mt-4 mb-16">

        <!-- Header y Contacto -->
        <header class="header">
            <h1 class="text-4xl font-extrabold mb-1 tracking-wider">SISTEMA DE PEDIDOS MAYORISTAS</h1>
            <p class="text-xl font-light opacity-90 mb-4">MULTIGESTIONES PY</p>
            <p class="text-lg font-medium bg-red-700 text-white p-2 rounded-lg">
                üö® Venta M√≠nima 3 Unidades por Art√≠culo (Abarrotes/Snacks) üö®
            </p>
        </header>

        <main class="p-4 sm:p-8">

            <!-- VISTA DEL CAT√ÅLOGO -->
            <div id="catalog-view">
                
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Cat√°logo de Productos</h2>
                    <button id="view-cart-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-200 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Ver Carrito (<span id="cart-count">0</span>)
                    </button>
                </div>
                
                <!-- Filtros -->
                <div class="mb-8">
                    <div id="filter-container" class="flex flex-wrap gap-2 sm:gap-4">
                        <!-- Botones de Categor√≠a se insertar√°n aqu√≠ -->
                    </div>
                </div>

                <!-- Lista de Productos -->
                <div id="product-list" class="space-y-2">
                    <!-- Los productos se insertar√°n aqu√≠ por JavaScript -->
                </div>

                <div id="loading-indicator" class="text-center py-10 text-xl text-gray-500">Conectando con la base de datos...</div>
            </div>


            <!-- VISTA DEL CARRITO Y FORMULARIO DE CONFIRMACI√ìN -->
            <div id="cart-view" class="hidden">
                <button id="back-to-catalog-btn" class="text-blue-600 hover:text-blue-800 font-medium mb-6 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Volver al Cat√°logo
                </button>

                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Resumen de Pedido</h2>

                <div id="cart-summary" class="bg-gray-50 p-4 rounded-xl mb-6">
                    <div id="cart-item-details" class="cart-item-list space-y-3 mb-4">
                        <!-- Detalles del carrito aqu√≠ -->
                        <p id="empty-cart-message" class="text-gray-500 text-center py-4">El carrito est√° vac√≠o.</p>
                    </div>

                    <div class="flex justify-between items-center pt-3 border-t border-gray-200">
                        <span class="text-xl font-bold text-gray-900">Total a Pagar (Gs.):</span>
                        <span id="cart-total" class="text-2xl font-extrabold text-red-600">Gs. 0</span>
                    </div>
                    <p id="min-qty-alert" class="text-sm text-red-600 mt-2 font-medium hidden">‚ö†Ô∏è **ATENCI√ìN:** Tienes art√≠culos de Abarrotes con menos de 3 unidades. Por favor, ajusta las cantidades.</p>
                </div>

                <!-- Formulario de Cliente -->
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Datos del Cliente</h3>
                <form id="client-form" class="space-y-4">
                    <div>
                        <label for="client-name" class="block text-sm font-medium text-gray-700">Nombre o Raz√≥n Social</label>
                        <input type="text" id="client-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="client-phone" class="block text-sm font-medium text-gray-700">Tel√©fono / WhatsApp</label>
                        <input type="text" id="client-phone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="client-address" class="block text-sm font-medium text-gray-700">Direcci√≥n de Entrega</label>
                        <textarea id="client-address" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></textarea>
                    </div>

                    <button type="submit" id="confirm-order-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition duration-200 disabled:opacity-50" disabled>
                        <span id="btn-text">CONFIRMAR PEDIDO Y ENVIAR</span>
                    </button>
                    <p id="order-status" class="text-center mt-3 font-medium hidden"></p>
                </form>
            </div>

            <!-- MODAL DE CONFIRMACI√ìN DE ENV√çO -->
            <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
                    <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h3 class="text-xl font-bold text-gray-900 mb-3">¬°Pedido Enviado con √âxito!</h3>
                    <p class="text-gray-600 mb-6">Tu orden ha sido registrada. Pronto nos contactaremos al n√∫mero proporcionado.</p>
                    <button id="close-modal-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Volver al inicio
                    </button>
                </div>
            </div>

        </main>
    </div>
</body>
</html>

