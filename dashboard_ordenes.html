<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, setLogLevel, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración Global de Firebase (MANDATORIA)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Variables globales
        let db = null;
        let auth = null;
        
        setLogLevel('debug'); // Activar logs de Firebase

        // Inicializar Firebase
        const authenticate = async () => {
             if (!firebaseConfig) {
                document.getElementById('loading-indicator').textContent = "Error: Configuración de Firebase no disponible.";
                return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                initDashboard(); 

            } catch (error) {
                console.error("Error de autenticación de Firebase:", error);
                document.getElementById('loading-indicator').textContent = "Error de conexión. Por favor, recarga o verifica tu conexión a Internet.";
            }
        };

        // --- ESTADO Y ELEMENTOS ---
        const ELEMENTS = {
            ordersList: document.getElementById('orders-list'),
            loadingIndicator: document.getElementById('loading-indicator'),
        };

        const STATUS_COLORS = {
            PENDIENTE: 'bg-yellow-100 text-yellow-800',
            'EN PROCESO': 'bg-blue-100 text-blue-800',
            ENTREGADO: 'bg-green-100 text-green-800',
        };

        const ALL_STATUS = ['PENDIENTE', 'EN PROCESO', 'ENTREGADO'];

        // --- FUNCIONES DE ORDENACIÓN ---
        function sortOrders(orders) {
            // Ordenar: PENDIENTES primero, y luego por timestamp (el más nuevo primero)
            return orders.sort((a, b) => {
                const statusOrder = { PENDIENTE: 1, 'EN PROCESO': 2, ENTREGADO: 3 };
                
                if (statusOrder[a.status] !== statusOrder[b.status]) {
                    return statusOrder[a.status] - statusOrder[b.status];
                }
                
                // Si el timestamp es un objeto Firestore, usa el método toDate()
                const dateA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(0);
                const dateB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(0);
                
                return dateB - dateA; // Más reciente primero
            });
        }

        // --- FUNCIÓN DE RENDERIZADO ---
        function renderOrders(orders) {
            ELEMENTS.ordersList.innerHTML = '';
            
            if (orders.length === 0) {
                ELEMENTS.ordersList.innerHTML = '<p class="text-center text-gray-500 py-10 text-lg">No hay pedidos registrados.</p>';
                return;
            }

            const sortedOrders = sortOrders(orders);

            sortedOrders.forEach(order => {
                const orderDate = order.timestamp && order.timestamp.toDate ? order.timestamp.toDate().toLocaleString('es-PY', { dateStyle: 'short', timeStyle: 'short' }) : 'Fecha desconocida';
                const statusColor = STATUS_COLORS[order.status] || 'bg-gray-200 text-gray-700';
                
                const orderCard = document.createElement('div');
                orderCard.className = 'bg-white p-5 rounded-xl shadow-lg border-l-4 ' + (order.status === 'PENDIENTE' ? 'border-red-500' : (order.status === 'EN PROCESO' ? 'border-blue-500' : 'border-green-500'));
                orderCard.dataset.id = order.id;

                let itemsHtml = order.items.map(item => `
                    <li class="flex justify-between text-sm text-gray-600 border-b border-gray-100 py-1">
                        <span class="font-medium">(${item.quantity} U.) ${item.name}</span>
                        <span class="${item.isRental ? 'text-red-500' : 'text-green-600'}">Gs. ${(item.subtotal || 0).toLocaleString('es-ES')}</span>
                    </li>
                `).join('');

                orderCard.innerHTML = `
                    <div class="flex justify-between items-start border-b pb-3 mb-3">
                        <div>
                            <p class="text-xs font-semibold text-gray-500">Pedido #${order.id.substring(0, 8).toUpperCase()}</p>
                            <p class="text-lg font-bold text-gray-900">${order.clientInfo.name}</p>
                        </div>
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColor}">${order.status}</span>
                    </div>

                    <div class="space-y-2 mb-4">
                        <p class="text-sm"><span class="font-semibold text-gray-700">Teléfono:</span> ${order.clientInfo.phone}</p>
                        <p class="text-sm"><span class="font-semibold text-gray-700">Dirección:</span> ${order.clientInfo.address}</p>
                        <p class="text-sm"><span class="font-semibold text-gray-700">Fecha:</span> ${orderDate}</p>
                    </div>

                    <h4 class="text-md font-bold text-gray-800 mt-4 mb-2">Detalle de Productos:</h4>
                    <ul class="list-none space-y-1 mb-4">${itemsHtml}</ul>
                    
                    <div class="flex justify-between items-center pt-3 border-t border-gray-200">
                        <span class="text-xl font-bold text-gray-900">Total:</span>
                        <span class="text-2xl font-extrabold text-red-600">Gs. ${order.totalAmount.toLocaleString('es-ES')}</span>
                    </div>

                    <div class="mt-4 flex flex-col sm:flex-row gap-2">
                        <!-- Selector de Estado -->
                        <select data-id="${order.id}" class="status-selector bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 flex-grow">
                            ${ALL_STATUS.map(status => `
                                <option value="${status}" ${order.status === status ? 'selected' : ''}>${status}</option>
                            `).join('')}
                        </select>
                    </div>
                `;

                ELEMENTS.ordersList.appendChild(orderCard);
            });
            
            // Adjuntar listener para el selector de estado
            document.querySelectorAll('.status-selector').forEach(select => {
                select.addEventListener('change', handleStatusChange);
            });
        }

        // --- MANEJADOR DE CAMBIO DE ESTADO ---
        async function handleStatusChange(e) {
            const orderId = e.target.dataset.id;
            const newStatus = e.target.value;
            
            if (!db) {
                console.error("Conexión a Firestore no establecida.");
                return;
            }

            e.target.disabled = true; // Deshabilitar mientras se actualiza

            const collectionPath = `/artifacts/${appId}/public/data/orders`;
            const orderRef = doc(db, collectionPath, orderId);

            try {
                await updateDoc(orderRef, {
                    status: newStatus
                });
                console.log(`Estado de orden ${orderId} actualizado a ${newStatus}`);
                // El onSnapshot se encargará de re-renderizar la lista
            } catch (error) {
                console.error("Error al actualizar el estado:", error);
                // Usar un modal o un mensaje de error en la UI si fuera una app de producción
            } finally {
                e.target.disabled = false;
            }
        }

        // --- INICIALIZACIÓN Y SUSCRIPCIÓN ---
        function initDashboard() {
            ELEMENTS.loadingIndicator.classList.add('hidden');
            
            if (!db || !auth.currentUser) {
                ELEMENTS.ordersList.innerHTML = '<p class="text-center text-red-500 py-10 text-lg">Error: No se pudo conectar a la base de datos de pedidos.</p>';
                return;
            }

            const collectionPath = `/artifacts/${appId}/public/data/orders`;
            const ordersQuery = query(collection(db, collectionPath));

            // Escuchar cambios en tiempo real
            onSnapshot(ordersQuery, (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                renderOrders(orders);
            }, (error) => {
                console.error("Error al escuchar pedidos:", error);
                ELEMENTS.ordersList.innerHTML = `<p class="text-center text-red-500 py-10 text-lg">Error al cargar pedidos: ${error.message}</p>`;
            });
        }

        authenticate();
    </script>
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        body {
            background-color: #f3f4f6;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="max-w-6xl mx-auto pt-4 pb-16">
        <header class="mb-8 p-6 bg-white rounded-xl shadow-md border-b-4 border-indigo-600">
            <h1 class="text-3xl font-extrabold text-gray-900">ADMINISTRACIÓN DE ÓRDENES</h1>
            <p class="text-gray-600">Pedidos recibidos en tiempo real para Multigestiones PY.</p>
        </header>

        <main>
            <div id="loading-indicator" class="text-center py-10 text-xl text-gray-500">Cargando pedidos...</div>
            <div id="orders-list" class="space-y-6">
                <!-- Las tarjetas de pedidos se insertarán aquí -->
            </div>
        </main>
    </div>
</body>
</html>

